<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Placement Test Tool</title>
</head>
<body>

<h2>Placement Test Tool</h2>

<label>رقم الطالب</label><br>
<input id="studentId"><br><br>

<label>العلامة</label><br>
<input id="score" type="number" min="0" max="100"><br><br>

<label>الدرجة العلمية</label><br>
<select id="degree">
  <option>Associate Degree</option>
  <option>Luminus BTEC Level 4 + 5</option>
  <option>Bachelor Degree</option>
</select><br><br>

<button onclick="submitResult()">حفظ النتيجة</button>

<p id="status"></p>

<script>
const levels = {
  "Luminus BTEC Level 4 + 5": [
    { min: 0, max: 25, name: "Foundation", code: "Pre-A1-ID" },
    { min: 26, max: 39, name: "Elementary", code: "A1-ID" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "A2-ID" },
    { min: 55, max: 69, name: "Intermediate", code: "B1-ID" },
    { min: 70, max: 79, name: "Upper Intermediate", code: "B2-ID" },
    { min: 80, max: 89, name: "Advanced", code: "C1-ID" },
    { min: 90, max: 100, name: "Proficiency", code: "C2-ID" }
  ],
  "Associate Degree": [
    { min: 0, max: 25, name: "Beginner", code: "BEG-A1" },
    { min: 26, max: 39, name: "Elementary", code: "EL-IA2" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "PRE-B1" },
    { min: 55, max: 69, name: "Intermediate", code: "INT-B2" },
    { min: 70, max: 79, name: "Upper Intermediate", code: "B2-AD" },
    { min: 80, max: 89, name: "Advanced", code: "C1-AD" },
    { min: 90, max: 100, name: "Proficiency", code: "C2-AD" }
  ],
  "Bachelor Degree": [
    { min: 0, max: 25, name: "English 99", code: "BA-ENG99" },
    { min: 26, max: 39, name: "Elementary", code: "BA-3EL" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "BA-3PRE" },
    { min: 55, max: 69, name: "Intermediate", code: "37700121" },
    { min: 70, max: 79, name: "Upper Intermediate English", code: "B2-BA" },
    { min: 80, max: 89, name: "Advanced English", code: "C1-BA" },
    { min: 90, max: 100, name: "Proficiency (English)", code: "C2-BA" }
  ]
};

function getLevel(score, degree) {
  const arr = levels[degree] || [];
  for (let i = 0; i < arr.length; i++) {
    if (score >= arr[i].min && score <= arr[i].max) return arr[i];
  }
  return { name: "", code: "" };
}

function getExemptedSubjects(score, degree) {
  const arr = levels[degree] || [];
  return arr
    .filter(l => l.max < score)
    .map(l => `${l.name} (${l.code})`)
    .join(", ");
}

function submitResult() {
  const studentId = document.getElementById("studentId").value.trim();
  const score = Number(document.getElementById("score").value);
  const degree = document.getElementById("degree").value;
  const statusEl = document.getElementById("status");

  if (!studentId || isNaN(score) || score < 0 || score > 100) {
    statusEl.innerText = "❌ الرجاء إدخال بيانات صحيحة";
    return;
  }

  const level = getLevel(score, degree);
  const exempted = getExemptedSubjects(score, degree);

  const data = {
    StudentID: studentId,
    Score: score,
    Degree: degree,
    LevelName: level.name,
    LevelCode: level.code,
    ExemptedSubjects: exempted
  };

  statusEl.innerText = "⏳ جاري الحفظ...";

  fetch("https://script.google.com/macros/s/AKfycbx6__Nq3JkAjlB6CXIyqZpCNWJuIF_Qs1zmVmOOJTMA3wTu5uJL5pK8YiY6gnxUkb51pg/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(resData => {
    if(resData.status === "success") {
      statusEl.innerText = "✅ تم حفظ النتيجة في Google Sheet";
    } else {
      statusEl.innerText = "❌ خطأ أثناء الحفظ: " + resData.message;
    }
  })
  .catch(err => {
    console.error(err);
    statusEl.innerText = "❌ خطأ أثناء الاتصال بالـ Google Sheet";
  });
}
</script>

</body>
</html>

