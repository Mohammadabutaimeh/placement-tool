<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Placement Test Tool</title>
</head>
<body>

<h2>Placement Test Tool</h2>

<label>رقم الطالب</label><br>
<input id="studentId" required><br><br>

<label>العلامة</label><br>
<input id="score" type="number" min="0" max="100" required><br><br>

<label>الدرجة العلمية</label><br>
<select id="degree">
  <option>Associate Degree</option>
  <option>Higher National Certificate Level 4</option>
  <option>Higher National Diploma Level 5</option>
  <option>Vocational Diploma</option>
  <option>Bachelor Degree</option>
</select><br><br>

<button onclick="submitResult()">حفظ النتيجة</button>

<p id="status"></p>

<script>
const levels = {
  "Associate Degree": [
    { min: 0, max: 25, name: "Beginner", code: "BEG-A1" },
    { min: 26, max: 39, name: "Elementary", code: "EL-IA2" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "PRE-B1" },
    { min: 55, max: 69, name: "Intermediate", code: "INT-B2" },
    { min: 70, max: 79, name: "Upper Intermediate", code: "B2-AD" },
    { min: 80, max: 89, name: "Advanced", code: "C1-AD" },
    { min: 90, max: 100, name: "Proficiency", code: "C2-AD" }
  ],
  "Higher National Certificate Level 4": [
    { min: 0, max: 25, name: "Beginner", code: "HNC-0" },
    { min: 26, max: 39, name: "Elementary", code: "HNC-1" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "HNC-2" },
    { min: 55, max: 69, name: "Intermediate", code: "HNC-3" },
    { min: 70, max: 79, name: "Upper Intermediate", code: "HNC-4" },
    { min: 80, max: 89, name: "Advanced", code: "HNC-5" },
    { min: 90, max: 100, name: "Proficiency", code: "HNC-6" }
  ],
  "Higher National Diploma Level 5": [
    { min: 0, max: 25, name: "Beginner", code: "HND-0" },
    { min: 26, max: 39, name: "Elementary", code: "HND-1" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "HND-2" },
    { min: 55, max: 69, name: "Intermediate", code: "HND-3" },
    { min: 70, max: 79, name: "Upper Intermediate", code: "HND-4" },
    { min: 80, max: 89, name: "Advanced", code: "HND-5" },
    { min: 90, max: 100, name: "Proficiency", code: "HND-6" }
  ],
  "Vocational Diploma": [
    { min: 0, max: 25, name: "Beginner", code: "VOC-0" },
    { min: 26, max: 39, name: "Elementary", code: "VOC-1" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "VOC-2" },
    { min: 55, max: 69, name: "Intermediate", code: "VOC-3" },
    { min: 70, max: 79, name: "Upper Intermediate", code: "VOC-4" },
    { min: 80, max: 89, name: "Advanced", code: "VOC-5" },
    { min: 90, max: 100, name: "Proficiency", code: "VOC-6" }
  ],
  "Bachelor Degree": [
    { min: 0, max: 25, name: "English 99", code: "BA-ENG99" },
    { min: 26, max: 39, name: "Elementary", code: "BA-3EL" },
    { min: 40, max: 54, name: "Pre-Intermediate", code: "BA-3PRE" },
    { min: 55, max: 69, name: "Intermediate", code: "37700121" },
    { min: 70, max: 79, name: "Upper Intermediate English", code: "B2-BA" },
    { min: 80, max: 89, name: "Advanced English", code: "C1-BA" },
    { min: 90, max: 100, name: "Proficiency (English)", code: "C2-BA" }
  ]
};

function getLevel(score, degree) {
  const arr = levels[degree] || [];
  for (let i = 0; i < arr.length; i++) {
    if (score >= arr[i].min && score <= arr[i].max) return arr[i];
  }
  return { name: "", code: "" };
}

function getExemptedSubjects(score, degree) {
  const arr = levels[degree] || [];
  return arr
    .filter(l => l.max < score)
    .map(l => `${l.name} (${l.code})`)
    .join(", ");
}

function submitResult() {
  const studentId = document.getElementById("studentId").value.trim();
  const score = Number(document.getElementById("score").value);
  const degree = document.getElementById("degree").value;
  const statusEl = document.getElementById("status");

  if (!studentId || isNaN(score) || score < 0 || score > 100) {
    statusEl.innerText = "❌ الرجاء إدخال بيانات صحيحة";
    return;
  }

  const level = getLevel(score, degree);
  const exempted = getExemptedSubjects(score, degree);

  const data = {
    StudentID: studentId,
    Score: score,
    Degree: degree,
    LevelName: level.name,
    LevelCode: level.code,
    ExemptedSubjects: exempted
  };

  statusEl.innerText = "⏳ جاري الحفظ...";

  fetch("https://60f3411127c0ea4eb2e044759845b2.42.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a39041f81d5458aaa8b63c3f3cf53c7/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=1r1D14EpiWwCbmoYQPWYWf_7f5Pak_SM_9SQ2CNoA64", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(res => {
    if(!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    statusEl.innerText = "✅ تم حفظ النتيجة في Dataverse";
  })
  .catch(err => {
    console.error(err);
    statusEl.innerText = "❌ خطأ أثناء الاتصال بالـ Dataverse";
  });
}
</script>

</body>
</html>
